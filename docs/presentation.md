# ハイブリッドAIで実現するプライバシーファースト設計

## ~ ローカルSLM × クラウドLLM による個人情報保護アーキテクチャ ~

**技術スタック**: Azure AI Foundry + Foundry Local (Phi-4-mini) + Python

---

## 本日のゴール

「**機密データを守りながら、AIの恩恵を最大限に受ける**」方法を理解する

- ハイブリッドAIアーキテクチャの仕組み
- 2つのユースケース（医療トリアージ、ファイナンシャルプランナー）
- プライバシー保護・コスト削減・規制対応の3つのメリット

---

# 1. 課題提起

## 問いかけ: あなたの機密データ、クラウドに送っていいですか？

以下のデータを外部のAIサービスに送信できますか？

- **医療記録**: 患者ID、検査結果、診断情報
- **金融情報**: 顧客の年収、資産額、取引履歴
- **社内文書**: 契約書、人事評価、営業戦略

多くの場合、答えは「**No**」または「**場合による**」ではないでしょうか。

---

## 従来のクラウドLLMアーキテクチャの課題

```
┌─────────────────────┐         ┌─────────────────────┐
│   機密データ         │  全て   │   クラウドLLM        │
│  ・患者ID: 12345    │ ──────> │   (GPT-4o等)        │
│  ・検査値: 14.5     │  送信   │                     │
│  ・年収: 800万円    │         │   🌐 インターネット   │
└─────────────────────┘         └─────────────────────┘
```

### 4つの課題

| # | 課題 | 説明 |
|---|------|------|
| 1 | **データ漏洩リスク** | 機密データが外部サーバーに保存される |
| 2 | **規制準拠の困難さ** | GDPR、HIPAA、個人情報保護法への対応が複雑 |
| 3 | **信頼性の問題** | 顧客や患者の信頼を損なう可能性 |
| 4 | **コストの増大** | 大量のトークンをクラウドに送信するコスト |

---

## 規制環境と現実のギャップ

生成AIを業務に活用したくても、規制が壁になるケースが多い。

| 規制/ガイドライン | 要求事項 | クラウドLLMでの課題 |
|-----------------|---------|-------------------|
| **GDPR** | データ最小化、越境移転制限 | クラウドは国外サーバーの可能性 |
| **個人情報保護法** | 目的外利用禁止 | LLM学習への利用懸念 |
| **HIPAA** | 医療情報の厳格管理 | APIログの保存期間問題 |
| **金融庁ガイドライン** | 顧客データ保護 | 外部委託先の監督義務 |

---

## ローカルLLM単独の限界

「じゃあ、全部ローカルで処理すればいいのでは？」

### ローカルLLMの利点
- プライバシー完全保護（データが外に出ない）
- 低遅延（ネットワーク不要）
- オフライン動作可能

### ローカルLLMの限界
- **モデルサイズの制約**: Phi-4-mini は 3.8B パラメータ（GPT-4oの数十分の一）
- **複雑な推論能力の不足**: 高度な判断、長文生成には力不足
- **最新知識の欠如**: 学習時点以降の情報がない

### 能力比較

| 項目 | GPT-4o（クラウド） | Phi-4-mini（ローカル） |
|-----|-------------------|----------------------|
| 推論能力 | ★★★★★ | ★★★☆☆ |
| モデルサイズ | 巨大（非公開） | 3.8B パラメータ |
| プライバシー | △（クラウド送信） | ◎（ローカル完結） |
| コスト | API課金 | 無料（自前GPU/NPU） |

---

## 解決策: ハイブリッドAIアーキテクチャ

**「機密データはローカルで処理し、高度な推論のみクラウドで実行する」**

```
┌─────────────────────┐
│   機密データ         │
│  ・患者ID: 12345    │
│  ・検査値: 14.5     │
│  ・年収: 800万円    │
└─────────┬───────────┘
          │
          ▼  ローカル処理（Foundry Local）
┌─────────────────────┐
│   匿名化・構造化      │
│  ・重症度: moderate  │   ← 具体的な数値は削除
│  ・資産比率: 37%     │   ← 金額は割合に変換
└─────────┬───────────┘
          │
          ▼  匿名化データのみ送信
┌─────────────────────┐
│   クラウドLLM        │
│   高度な推論         │
│   ガイダンス生成     │
└─────────────────────┘
```

**ポイント**: 機密データはローカルで止まり、クラウドには匿名化されたデータのみが送信される

---

# 2. アーキテクチャ解説

## 全体アーキテクチャ図

```
┌────────────────────────────────────────────────────────────────┐
│                        ユーザー入力                              │
│              （医療データ / 金融データ）                          │
└────────────────────────────────────────────────────────────────┘
                                │
                                ▼
┌────────────────────────────────────────────────────────────────┐
│                  Azure AI Agent Framework                       │
│                   （オーケストレーション層）                       │
│  ┌──────────────────────────────────────────────────────────┐  │
│  │  ChatAgent                                                │  │
│  │  - ユーザー入力の解析                                       │  │
│  │  - ツール呼び出し判断（検査データ検出 → ローカルツール実行）   │  │
│  │  - 最終応答の生成                                          │  │
│  └──────────────────────────────────────────────────────────┘  │
└────────────────────────────────────────────────────────────────┘
                    │                              │
       ローカルツール呼び出し                    最終推論
                    │                              │
                    ▼                              ▼
┌──────────────────────────────┐  ┌──────────────────────────────┐
│     Foundry Local             │  │     Azure AI Foundry          │
│     （ローカル処理）           │  │     （クラウド処理）           │
│  ┌──────────────────────┐    │  │  ┌──────────────────────┐    │
│  │  Phi-4-mini           │    │  │  │  GPT-4o              │    │
│  │  ────────────────────│    │  │  │  ────────────────────│    │
│  │  • データ構造化       │    │  │  │  • 高度な推論         │    │
│  │  • 匿名化処理         │    │  │  │  • ガイダンス生成     │    │
│  │  • 異常値抽出        │    │  │  │  • 複雑な判断         │    │
│  └──────────────────────┘    │  │  └──────────────────────┘    │
│                              │  │                              │
│  🔒 機密データはここで止まる   │  │  📤 匿名化データのみ受信     │
└──────────────────────────────┘  └──────────────────────────────┘
```

---

## データフローの詳細

### シーケンス図

```
ユーザー        Agent Framework      Foundry Local      Azure AI
   │                 │                   │                │
   │─── 機密データ ──>│                   │                │
   │                 │                   │                │
   │                 │── ローカルツール呼出 ─>│                │
   │                 │                   │                │
   │                 │    [ローカルで処理]   │                │
   │                 │    • データ構造化     │                │
   │                 │    • 匿名化          │                │
   │                 │                   │                │
   │                 │<── 匿名化データ ────│                │
   │                 │                   │                │
   │                 │──── 匿名化データ ──────────────────>│
   │                 │                   │                │
   │                 │<──── 推論結果 ───────────────────────│
   │                 │                   │                │
   │<── 最終応答 ────│                   │                │
```

### 重要なポイント

- **機密データはローカルで処理** → クラウドには送信されない
- **クラウドに渡るのは匿名化・構造化されたデータのみ**
- **Agent Framework が自動的にツール呼び出しを判断**

---

## 技術スタック

| コンポーネント | 技術 | 役割 |
|--------------|------|------|
| **ローカルSLM** | Foundry Local + Phi-4-mini | データ匿名化・構造化 |
| **クラウドLLM** | Azure AI Foundry + GPT-4o | 高度な推論・アドバイス生成 |
| **オーケストレーション** | Azure AI Agent Framework | ツール呼び出し制御 |
| **UI** | Streamlit | ユーザーインターフェース |
| **言語** | Python 3.10+ | 実装言語 |

### Foundry Local の特徴

- **Windows 11 で動作**: `winget install Microsoft.FoundryLocal` で簡単導入
- **NPU/CUDA対応**: Intel/AMD NPU、NVIDIA CUDA に対応
- **OpenAI互換API**: `http://localhost:56234/v1/chat/completions`
- **Phi-4-mini**: 3.8Bパラメータの高性能小型モデル

---

# 3. ユースケース詳細

## ユースケース1: 医療トリアージ支援

### シナリオ

患者の症状と検査結果から、非緊急トリアージのガイダンスを提供する。

**課題**: 検査データには患者ID、具体的な検査値など機密情報が含まれる。これをそのままクラウドに送信することはできない。

**解決策**: ローカルSLMで検査レポートを構造化・匿名化し、クラウドLLMでトリアージ判断を行う。

---

### Before/After 比較

#### Before（従来のアプローチ）

```
検査レポート（生データ）
┌──────────────────────────────────┐
│ 患者ID: 12345                    │
│ 氏名: 山田太郎                    │
│ 白血球数: 14.5 x10^3/µL          │
│ CRP: 60 mg/L                     │
│ ...                              │
└──────────────────────────────────┘
         │
         │ そのまま送信  ⚠️ 規制違反リスク
         ▼
┌──────────────────────────────────┐
│ クラウドLLM                       │
│ → 患者の個人情報がクラウドに保存  │
└──────────────────────────────────┘
```

#### After（ハイブリッドアプローチ）

```
検査レポート（生データ）
┌──────────────────────────────────┐
│ 患者ID: 12345                    │  ← ローカルで処理
│ 氏名: 山田太郎                    │
│ 白血球数: 14.5 x10^3/µL          │
│ CRP: 60 mg/L                     │
└──────────────────────────────────┘
         │
         ▼ Foundry Local（ローカル処理）
┌──────────────────────────────────┐
│ 匿名化JSON:                       │
│ {                                │
│   "overall_assessment":          │
│     "炎症マーカー上昇",           │
│   "notable_abnormal_results": [  │
│     {"test": "WBC",              │
│      "severity": "moderate"},    │
│     {"test": "CRP",              │
│      "severity": "severe"}       │
│   ]                              │
│ }                                │
└──────────────────────────────────┘
         │
         │ 匿名化データのみ送信 ✅
         ▼
┌──────────────────────────────────┐
│ クラウドLLM                       │
│ → トリアージガイダンス生成        │
└──────────────────────────────────┘
```

---

### 実装コード

```python
from typing import Annotated, Dict, Any
from pydantic import Field
from agent_framework import ai_function

@ai_function(
    name="summarize_lab_report",
    description="ユーザーのGPU上で動作するローカルモデルを使用して、"
                "生の検査レポートを構造化された異常値に要約します。"
)
def summarize_lab_report(
    lab_text: Annotated[str, Field(description="検査レポートの生テキスト")]
) -> Dict[str, Any]:
    """
    ローカルモデル（Phi-4-mini）で検査レポートを処理
    - 個人識別情報を除去
    - 異常値のみを構造化
    """
    response, log_entry = call_local_model(
        system_prompt=LOCAL_LAB_SYSTEM_PROMPT,
        user_content=lab_text,
        tool_name="summarize_lab_report",
    )
    return parse_json_response(extract_content(response))
```

**ポイント**:
- `@ai_function` デコレータでAgent Frameworkにツールを登録
- Agent Framework が自動的に検査レポートを検出してこのツールを呼び出す
- 返り値はJSON形式（クラウドLLMが解釈しやすい）

---

### ローカルモデル用システムプロンプト

ローカルSLM（Phi-4-mini）に対して、JSON出力を強制するプロンプト設計：

```
【絶対ルール】
- 出力はJSON構造のみ。それ以外は一切出力禁止。
- バッククォート(```)で囲まない。
- 回答は必ず { で始まり } で終わること。

【出力形式】
{
  "overall_assessment": "短い日本語要約",
  "notable_abnormal_results": [
    {
      "test": "検査項目名",
      "severity": "mild|moderate|severe"
    }
  ]
}
```

---

## ユースケース2: ファイナンシャルプランナー

### シナリオ

個人の資産情報とライフプランから、ファイナンシャルアドバイスを提供する。

**課題**: 入力データには具体的な資産額（500万円、年収800万円等）が含まれる。これをそのままクラウドに送信することはできない。

**解決策**: 2つのローカルツールで匿名化・構造化：
1. `analyze_financial_assets`: 資産の匿名化（金額 → 割合）
2. `analyze_life_plan`: ライフプランの匿名化（年齢 → ライフステージ）

---

### 匿名化の仕組み

| 入力（機密） | 出力（匿名化） |
|------------|---------------|
| 銀行預金: **5,000,000円** | cash_equivalents: **37.3%** |
| NISA: **2,400,000円** | tax_advantaged: **17.9%** |
| 年収: **8,000,000円** | income_category: **"高"** |
| 年齢: **45歳** | life_stage: **"子育て後期"** |
| 資産総額: **13,400,000円** | total_category: **"1000万円〜2000万円"** |

**ポイント**:
- 具体的な金額は一切クラウドに送信しない
- 割合とカテゴリに変換することで、アドバイスに必要な情報は保持

---

### プライバシー保護のデータフロー表

| 情報 | ローカル処理 | クラウド送信 |
|------|:-----------:|:-----------:|
| 具体的な資産金額（5,000,000円） | ○ | ✕ |
| 具体的な年齢（45歳） | ○ | ✕ |
| 具体的な年収（800万円） | ○ | ✕ |
| 家族の人数・詳細 | ○ | ✕ |
| 資産の割合（37.3%） | - | ○ |
| 資産カテゴリ（1000万円〜2000万円） | - | ○ |
| ライフステージ（子育て後期） | - | ○ |
| 時期の目安（3年後、10年後） | - | ○ |

---

### 出力例

#### ローカル処理結果（匿名化後）

```json
{
  "total_assets_category": "1000万円〜2000万円",
  "asset_allocation": {
    "cash_equivalents": {
      "percentage": 37.3,
      "includes": ["銀行預金"]
    },
    "investment_securities": {
      "percentage": 40.3,
      "includes": ["NISA", "課税口座株式"]
    }
  },
  "risk_assessment": {
    "diversification_score": "moderate",
    "liquidity_ratio": 37.3
  }
}
```

#### クラウドLLMからの応答

```
【ファイナンシャルプランニングアドバイス】

資産配分の評価:
✓ 流動性資産が適切に確保されている
✓ NISA制度を有効活用している
△ 株式比率がやや高め（教育費ピークを考慮すると）

ライフステージに応じた考慮事項:
・3年後の第一子大学進学に向けた資金計画の詳細化が必要
・10年後のローン完済後のキャッシュフロー改善を活用できる

※この情報は一般的な参考情報であり、投資助言ではありません。
具体的な資産運用については、資格を持つファイナンシャルプランナーに
ご相談ください。
```

---

# 4. 3つの重点ポイント

## ポイント1: プライバシー保護の重要性

### なぜプライバシー保護が重要か

#### 1. 規制遵守の義務

| 規制 | 違反時の制裁 |
|-----|------------|
| GDPR | 最大2,000万ユーロ or 全世界売上高の4% |
| 個人情報保護法 | 1億円以下の罰金（法人） |
| HIPAA | 最大150万ドル/年 + 刑事罰 |

#### 2. 顧客・患者の信頼

- 医療機関: 「私の検査データがどこに送られているか分からない」では信頼を失う
- 金融機関: 「資産情報が外部に漏洩するリスクがある」では口座を預けられない

#### 3. データ漏洩リスク

- クラウドサービスへの攻撃
- 内部不正
- 設定ミスによる公開

---

### 本アーキテクチャでのプライバシー保護

```
┌─────────────────────────────────────────────────────────────┐
│                     プライバシー保護の仕組み                   │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  [ローカル環境]                    [クラウド環境]             │
│  ┌─────────────────────┐          ┌─────────────────────┐  │
│  │ 機密データ           │          │ 匿名化データ         │  │
│  │ ・患者ID            │   ──✕──> │ ・重症度のみ         │  │
│  │ ・具体的な検査値    │          │ ・割合のみ           │  │
│  │ ・資産金額          │          │ ・カテゴリのみ       │  │
│  │ ・年齢・年収        │          │                     │  │
│  └─────────────────────┘          └─────────────────────┘  │
│        │                                   ↑               │
│        │ Foundry Local で処理              │               │
│        └───────────────────────────────────┘               │
│                                                             │
│  🔒 機密データはデバイスを離れない                           │
└─────────────────────────────────────────────────────────────┘
```

---

## ポイント2: コスト削減効果

### コスト構造の比較

#### 従来のクラウドLLMのみ

```
入力トークン: 検査レポート全文（約2,000トークン）
出力トークン: ガイダンス（約500トークン）
──────────────────────────────────────
合計: 2,500トークン/リクエスト × API単価
```

#### ハイブリッドアーキテクチャ

```
[ローカル処理（無料）]
入力: 検査レポート全文（約2,000トークン）
出力: 構造化JSON（約200トークン）
コスト: ¥0（自前GPU/NPU使用）

[クラウド処理]
入力: 構造化JSON（約200トークン）← 90%削減！
出力: ガイダンス（約500トークン）
──────────────────────────────────────
合計: 700トークン/リクエスト × API単価
```

### コスト削減効果

| 項目 | 従来 | ハイブリッド | 削減率 |
|-----|------|------------|-------|
| クラウドへの入力トークン | 2,000 | 200 | **90%削減** |
| API課金対象トークン | 2,500 | 700 | **72%削減** |
| ローカル処理コスト | - | ¥0 | - |

### 追加のコストメリット

1. **オフライン処理可能**: ネットワーク接続不要時でもローカル処理は継続
2. **レイテンシ削減**: ローカル処理は数百ミリ秒で完了
3. **スケーラビリティ**: ローカル処理能力を増やすことでクラウド依存を軽減

---

## ポイント3: 規制産業での活用可能性

### 医療分野

| 規制・ガイドライン | 要求事項 | ハイブリッドAIでの対応 |
|-----------------|---------|---------------------|
| 医療情報システムの安全管理GL | 個人情報の適切な管理 | 検査データはローカル処理 |
| HIPAA（米国） | PHIの保護 | 患者IDはクラウド非送信 |
| 3省2ガイドライン | 医療情報の安全性確保 | 匿名化後のみ外部連携 |

**活用例**:
- 症状チェッカー
- 検査結果の事前トリアージ
- 医療文書の構造化

---

### 金融分野

| 規制・ガイドライン | 要求事項 | ハイブリッドAIでの対応 |
|-----------------|---------|---------------------|
| 金融庁監督指針 | 顧客情報の適切な管理 | 資産金額はローカル処理 |
| 個人情報保護法 | 目的外利用の禁止 | 匿名化データのみ活用 |
| FISC安全対策基準 | 外部委託先の管理 | クラウドには一般情報のみ |

**活用例**:
- ファイナンシャルプランニング支援
- 投資ポートフォリオ分析
- ローン審査補助（匿名化後）

---

### 法務分野

| 規制・ガイドライン | 要求事項 | ハイブリッドAIでの対応 |
|-----------------|---------|---------------------|
| 弁護士職務基本規程 | 秘密保持義務 | 契約内容はローカル処理 |
| 弁護士秘匿特権 | 依頼者情報の保護 | 当事者名はクラウド非送信 |

**活用例**:
- 契約書レビュー（当事者名を匿名化）
- 法的リサーチ（事実関係を一般化）
- デューデリジェンス補助

---

### 人事・採用分野

| 規制・ガイドライン | 要求事項 | ハイブリッドAIでの対応 |
|-----------------|---------|---------------------|
| 個人情報保護法 | 従業員情報の保護 | 個人特定情報はローカル処理 |
| 労働基準法 | 人事情報の適切管理 | 評価内容はクラウド非送信 |

**活用例**:
- 履歴書スクリーニング（個人情報を除去して適性判断）
- 人事評価支援（評価観点のみを抽出）

---

# 5. ライブデモ

## デモ環境

- **Streamlit UI**: `streamlit run app.py`
- **Foundry Local**: `http://localhost:56234` で稼働中
- **Azure AI Foundry**: クラウド接続済み

## デモシナリオ

### 医療トリアージ

1. 患者症例を入力
2. 検査レポートを添付
3. **ツール呼び出しログ** を確認
   - `summarize_lab_report` がローカルで実行される様子
   - 匿名化JSONがクラウドに送信される様子
4. トリアージガイダンスが生成される

### ファイナンシャルプランナー

1. 資産情報を入力
2. 家族構成・ライフプランを入力
3. **ツール呼び出しログ** を確認
   - `analyze_financial_assets` がローカルで実行
   - `analyze_life_plan` がローカルで実行
   - 匿名化データがクラウドに送信
4. ファイナンシャルアドバイスが生成される

---

# 6. まとめ

## Key Takeaways

### 1. ハイブリッドAIで「プライバシー保護 × AI活用」を両立

- 機密データはローカルで処理
- クラウドには匿名化データのみ送信
- 両者の強みを組み合わせる

### 2. 役割分担の明確化

| 処理 | 担当 | 理由 |
|-----|------|------|
| データ構造化・匿名化 | ローカルSLM | プライバシー保護 |
| 高度な推論・アドバイス生成 | クラウドLLM | 推論能力の活用 |

### 3. 実装は意外とシンプル

- Foundry Local: `winget install` で導入、OpenAI互換API
- Agent Framework: `@ai_function` デコレータでツール登録
- 既存のPythonスキルで実装可能

### 4. 3つのメリット

| メリット | 詳細 |
|---------|------|
| **プライバシー保護** | 機密データがデバイスを離れない |
| **コスト削減** | クラウドAPI呼び出しを最大72%削減 |
| **規制対応** | 医療・金融・法務などの規制産業で活用可能 |

---

## 今後の展望

### 機能拡張

- **複数ツールの追加**: 画像診断、薬剤相互作用チェック、税務シミュレーション
- **モデルの動的切り替え**: 症状や分野に応じた専門モデルの選択
- **マルチエージェント構成**: 複数のエージェントが協調して処理

### 技術発展

- **NPU最適化**: より高速なローカル処理
- **モデルの進化**: より高性能な小型モデルの登場
- **オフライン完全対応**: インターネット接続なしでの基本動作

---

## リソース

- **GitHub**: [リポジトリURL]
- **技術ブログ**: Microsoft Tech Community "Hybrid AI using Foundry Local"
- **Foundry Local**: `winget install Microsoft.FoundryLocal`
- **Azure AI Agent Framework**: `pip install agent-framework-azure-ai --pre`

---

## Q&A

ご質問をお待ちしています。

---

# 付録

## プロジェクト構成

```
hybrid-ai-foundry-local-and-microsoft-foundry/
├── common/                    # 共通モジュール
│   ├── foundry_local.py       # Foundry Local接続クライアント
│   ├── llm_logger.py          # LLM入出力ログ管理
│   ├── prompt_loader.py       # プロンプトファイルローダー
│   └── utils.py               # ユーティリティ関数
│
├── medical/                   # 医療トリアージエージェント
│   ├── agent.py               # summarize_lab_report ツール実装
│   ├── DESIGN.md              # 設計書
│   └── data/                  # サンプル患者データ
│
├── finance/                   # ファイナンシャルプランナーエージェント
│   ├── agent.py               # analyze_* ツール実装
│   ├── DESIGN.md              # 設計書
│   └── data/                  # サンプル資産データ
│
├── app.py                     # Streamlit UI
├── requirements.txt           # 依存パッケージ
└── README.md                  # プロジェクト説明
```

## セットアップ手順

```powershell
# 1. Foundry Localのインストール
winget install Microsoft.FoundryLocal

# 2. モデルのダウンロード・ロード
foundry model download phi-4-mini
foundry model load phi-4-mini

# 3. Azure CLIログイン
az login

# 4. 依存パッケージインストール
pip install -r requirements.txt

# 5. 実行
streamlit run app.py
```
