# ファイナンシャルプランナーエージェント設計書

## 1. 概要

本システムは、ローカルGPU上で動作するAIモデル（Microsoft Foundry Local）とクラウドベースのAIエージェント（Azure AI Agent Framework）を組み合わせた**ハイブリッド型ファイナンシャルプランニング支援システム**です。

### 1.1 目的

- 個人の金融資産と家族構成を分析し、ライフプランニングの参考情報を提供する
- 機密性の高い金融データ（具体的な金額、年齢、年収）をローカルで処理し、プライバシーを保護する
- クラウドエージェントの高度な推論能力とローカルモデルの低遅延処理を組み合わせる

### 1.2 システム構成図

```
┌─────────────────────────────────────────────────────────────────┐
│                        ユーザー入力                              │
│              （金融資産JSON + 家族構成JSON）                      │
└─────────────────────────────────────────────────────────────────┘
                                │
                                ▼
┌─────────────────────────────────────────────────────────────────┐
│                   Azure AI Agent Framework                       │
│                （クラウドファイナンシャルプランナー）               │
│                                                                  │
│  ┌────────────────────────────────────────────────────────────┐ │
│  │ FINANCIAL_PLANNER_INSTRUCTIONS                              │ │
│  │ - 免責事項の遵守                                             │ │
│  │ - ツール呼び出し判断                                         │ │
│  │ - 統合アドバイス生成                                         │ │
│  └────────────────────────────────────────────────────────────┘ │
└─────────────────────────────────────────────────────────────────┘
                                │
            ┌───────────────────┴───────────────────┐
            │                                       │
            ▼                                       ▼
┌───────────────────────────┐       ┌───────────────────────────┐
│  analyze_financial_assets │       │     analyze_life_plan     │
│      （ローカル処理）       │       │      （ローカル処理）       │
│                           │       │                           │
│  入力: 具体的な金額        │       │  入力: 具体的な年齢・年収   │
│  出力: 匿名化された割合    │       │  出力: 匿名化されたタイムライン│
└───────────────────────────┘       └───────────────────────────┘
            │                                       │
            ▼                                       ▼
┌─────────────────────────────────────────────────────────────────┐
│                   Foundry Local Service                          │
│              http://127.0.0.1:52403/v1/chat/completions          │
│                                                                  │
│  ┌────────────────────────────────────────────────────────────┐ │
│  │ Phi-4-mini-instruct-cuda-gpu:5                              │ │
│  │ - 金融資産の構造化・匿名化                                   │ │
│  │ - ライフプランの構造化・匿名化                               │ │
│  └────────────────────────────────────────────────────────────┘ │
└─────────────────────────────────────────────────────────────────┘
                                │
                                ▼
┌─────────────────────────────────────────────────────────────────┐
│                      最終出力                                    │
│     （資産分析 + ライフプラン + 統合アドバイス + 免責事項）        │
└─────────────────────────────────────────────────────────────────┘
```

---

## 2. コンポーネント詳細

### 2.1 クラウドファイナンシャルプランナー（Azure AI Agent）

| 項目 | 内容 |
|------|------|
| **役割** | ユーザー入力を受け取り、ファイナンシャルプランニングアドバイスを生成 |
| **フレームワーク** | Azure AI Agent Framework (`agent_framework.azure`) |
| **認証** | Azure CLI Credential（非同期） |
| **エージェント名** | `hybrid-financial-planner` |

#### システムプロンプト（FINANCIAL_PLANNER_INSTRUCTIONS）

```
機能:
1. ツール呼び出し判断
   - 資産情報 → analyze_financial_assets
   - 家族情報 → analyze_life_plan

2. 分析結果の統合
   - 資産配分の評価（良い点・改善点）
   - ライフステージに応じた考慮事項
   - リスク分散の観点からの気づき

3. 免責事項
   - 投資アドバイスではない
   - 金融商品の推奨なし
   - 専門家への相談を推奨

出力制約:
- 平易な日本語で8項目以下
- 専門用語には説明を添える
- 必ず免責事項で終了
```

### 2.2 ローカル資産分析ツール（Foundry Local）

| 項目 | 内容 |
|------|------|
| **役割** | 金融資産データを匿名化・構造化 |
| **モデル** | Phi-4-mini-instruct-cuda-gpu:5 |
| **エンドポイント** | `http://127.0.0.1:52403/v1/chat/completions` |
| **API形式** | OpenAI互換 |

#### 入力形式

```json
{
  "bank_savings": {"description": "銀行口座", "amount": 5000000},
  "nisa_growth": {"description": "NISA成長投資枠", "amount": 2400000},
  "nisa_reserve": {"description": "NISA積立投資枠", "amount": 1200000},
  "stocks_non_nisa": {"description": "課税口座の株式", "amount": 3000000},
  "insurance": {"description": "保険", "amount": 800000},
  "government_bonds": {"description": "国債", "amount": 1000000}
}
```

#### 出力形式（匿名化済み）

```json
{
  "total_assets_category": "1000万円〜2000万円",
  "asset_allocation": {
    "cash_equivalents": {"percentage": 37.3, "includes": ["銀行預金"]},
    "investment_securities": {"percentage": 49.3, "includes": ["NISA", "株式"]},
    "fixed_income": {"percentage": 7.5, "includes": ["国債"]},
    "insurance_products": {"percentage": 6.0, "includes": ["保険"]}
  },
  "risk_assessment": {
    "diversification_score": "moderate",
    "liquidity_ratio": 37.3,
    "tax_advantaged_ratio": 26.9,
    "observations": ["流動性資産が高め", "NISA活用進行中"]
  },
  "nisa_utilization": {
    "growth_quota_used": true,
    "reserve_quota_used": true,
    "annual_limit_status": "確認必要"
  }
}
```

### 2.3 ローカルライフプラン分析ツール（Foundry Local）

#### 入力形式

```json
{
  "current_family": {
    "self": {"age": 45, "occupation": "会社員", "annual_income": 8000000},
    "spouse": {"age": 42, "occupation": "パート", "annual_income": 1200000},
    "children": [
      {"age": 15, "education_stage": "中学3年"},
      {"age": 12, "education_stage": "小学6年"}
    ]
  },
  "future_events": [
    {"event": "第一子大学進学", "years_from_now": 3},
    {"event": "本人退職", "years_from_now": 20}
  ]
}
```

#### 出力形式（匿名化済み）

```json
{
  "household_type": "子育て世帯（教育費準備期）",
  "income_structure": {
    "type": "共働き",
    "primary_income_ratio": 87,
    "stability": "安定雇用"
  },
  "life_stage_timeline": [
    {"period": "短期（1-3年）", "events": ["教育費増加"], "financial_priority": "教育資金確保"},
    {"period": "中期（4-10年）", "events": ["教育費ピーク"], "financial_priority": "支出管理"},
    {"period": "長期（11-20年）", "events": ["退職準備"], "financial_priority": "老後資金"}
  ],
  "key_financial_milestones": [
    {"milestone": "大型教育費", "timing": "3-10年後", "estimated_impact": "高"}
  ],
  "risk_factors": ["教育費と投資のバランス", "配偶者の収入継続性"]
}
```

---

## 3. データプライバシー保護

### 3.1 データフロー

| 情報 | ローカル処理 | クラウド送信 |
|------|-------------|-------------|
| 具体的な資産金額 | ○ | × |
| 具体的な年齢 | ○ | × |
| 具体的な年収 | ○ | × |
| 家族の人数 | ○ | × |
| 資産の割合（%） | - | ○ |
| 資産カテゴリ範囲 | - | ○ |
| ライフステージ | - | ○ |
| 時期（「3年後」等） | - | ○ |

### 3.2 プライバシー保護のメカニズム

1. **ローカル処理**: Foundry Localがユーザーのマシン上でデータを処理
2. **匿名化**: 具体的な数値を割合やカテゴリに変換
3. **構造化**: クラウドに送信するのは分析結果のJSONのみ

---

## 4. 技術仕様

### 4.1 設定パラメータ

| パラメータ | 値 | 説明 |
|-----------|-----|------|
| `FOUNDRY_LOCAL_BASE` | `http://127.0.0.1:56234` | Foundry Localエンドポイント |
| `FOUNDRY_LOCAL_MODEL_ID` | `phi-4-mini-instruct-vitis-npu:2` | 使用モデル |
| `max_tokens` | 1024 | ローカルモデル最大トークン |
| `temperature` | 0.2 | ローカルモデル温度 |
| `timeout` | 120秒 | HTTPリクエストタイムアウト |

### 4.2 対応する資産カテゴリ

| カテゴリ | 含まれる資産 |
|---------|-------------|
| 現金同等物 | 銀行預金、普通預金、定期預金 |
| 投資有価証券 | NISA、iDeCo、株式、投資信託 |
| 債券 | 国債、社債 |
| 保険商品 | 生命保険、個人年金保険 |

---

## 5. セキュリティ考慮事項

### 5.1 免責事項

- すべての出力に「投資助言ではありません」の免責事項を付与
- 具体的な金融商品の推奨は行わない設計
- 専門家への相談を推奨

### 5.2 データ保護

- 機密性の高い金融データはクラウドに送信されない
- ローカル処理により規制要件（GDPR等）への対応が容易

---

## 6. 実行方法

### 6.1 前提条件

1. **Foundry Localのインストール・起動**
   ```powershell
   winget install Microsoft.FoundryLocal
   foundry model download phi-4-mini
   foundry model load phi-4-mini
   foundry service status  # ポート確認
   ```

2. **Azure CLIログイン**
   ```powershell
   az login
   ```

3. **依存パッケージのインストール**
   ```powershell
   pip install -r requirements.txt
   ```

### 6.2 実行

```powershell
# プロジェクトルートから実行
python -m finance.agent
```

---

## 7. ファイル構成

```
finance/
├── __init__.py          # パッケージ初期化
├── agent.py             # メインエージェント
├── DESIGN.md            # 本設計書
└── README.md            # ユースケース説明
```

---

## 8. 医療エージェントとの比較

| 項目 | 医療エージェント | 金融エージェント |
|------|-----------------|-----------------|
| ローカルツール数 | 1（検査レポート要約） | 2（資産分析、ライフプラン） |
| 匿名化対象 | 患者ID、検査値 | 金額、年齢、年収 |
| クラウドへ送信 | 異常値の要約 | 割合・カテゴリ情報 |
| 免責事項 | 「医学的アドバイスではない」 | 「投資助言ではない」 |

---

## 9. 改訂履歴

| 日付 | バージョン | 内容 |
|------|-----------|------|
| 2025/11/30 | 1.0 | 初版作成 |
