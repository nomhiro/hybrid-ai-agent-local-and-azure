# 医療診断エージェント設計書

## 1. 概要

本システムは、ローカルGPU上で動作するAIモデル（Microsoft Foundry Local）とクラウドベースのAIエージェント（Azure AI Agent Framework）を組み合わせた**ハイブリッド型医療診断支援システム**です。

### 1.1 目的

- 非緊急医療診断のガイダンスを提供する
- 検査レポートの構造化要約をローカルで処理し、プライバシーを保護する
- クラウドエージェントの高度な推論能力とローカルモデルの低遅延処理を組み合わせる

### 1.2 システム構成図

```
┌─────────────────────────────────────────────────────────────────┐
│                        ユーザー入力                              │
│              （患者症例 + 検査レポートテキスト）                   │
└─────────────────────────────────────────────────────────────────┘
                                │
                                ▼
┌─────────────────────────────────────────────────────────────────┐
│                   Azure AI Agent Framework                       │
│                  （クラウド症状チェッカー）                        │
│                                                                  │
│  ┌────────────────────────────────────────────────────────────┐ │
│  │ SYMPTOM_CHECKER_INSTRUCTIONS                                │ │
│  │ - レッドフラグ症状の検出                                     │ │
│  │ - 診断ガイダンスの生成                                       │ │
│  │ - ツール呼び出し判断                                         │ │
│  └────────────────────────────────────────────────────────────┘ │
└─────────────────────────────────────────────────────────────────┘
                                │
                    検査データがある場合
                                │
                                ▼
┌─────────────────────────────────────────────────────────────────┐
│                summarize_lab_report ツール                       │
│                    （ローカル処理）                               │
└─────────────────────────────────────────────────────────────────┘
                                │
                                ▼
┌─────────────────────────────────────────────────────────────────┐
│                   Foundry Local Service                          │
│              http://127.0.0.1:52403/v1/chat/completions          │
│                                                                  │
│  ┌────────────────────────────────────────────────────────────┐ │
│  │ Phi-4-mini-instruct-cuda-gpu:5                              │ │
│  │ - 検査レポートのJSON構造化                                   │ │
│  │ - 異常値の抽出・重症度判定                                   │ │
│  └────────────────────────────────────────────────────────────┘ │
└─────────────────────────────────────────────────────────────────┘
                                │
                                ▼
┌─────────────────────────────────────────────────────────────────┐
│                      最終出力                                    │
│            （診断ガイダンス + 検査要約）                          │
└─────────────────────────────────────────────────────────────────┘
```

---

## 2. コンポーネント詳細

### 2.1 クラウド症状チェッカー（Azure AI Agent）

| 項目 | 内容 |
|------|------|
| **役割** | ユーザー入力を受け取り、診断ガイダンスを生成 |
| **フレームワーク** | Azure AI Agent Framework (`agent_framework.azure`) |
| **認証** | Azure CLI Credential（非同期） |
| **エージェント名** | `hybrid-symptom-checker` |

#### システムプロンプト（SYMPTOM_CHECKER_INSTRUCTIONS）

```
機能:
1. レッドフラグ症状の検出
   - 胸痛、呼吸困難、重度の出血、脳卒中兆候
   - 片側脱力、意識混濁、失神
   → 検出時は緊急医療を勧告して終了

2. 非緊急ケースの処理
   - 主要因の要約（年齢層、期間、重症度）
   - 次のステップの提案
   - 医師連絡タイミングのガイダンス
   - セルフケアアドバイス

3. ツール使用判断
   - 検査レポートテキスト検出時
   - `summarize_lab_report`ツールを自動呼び出し

出力制約:
- 平易な言葉で8項目以下
- 必ず「これは医学的アドバイスではありません。」で終了
- 生JSONは非公開（要約のみ提示）
```

### 2.2 ローカル検査要約ツール（Foundry Local）

| 項目 | 内容 |
|------|------|
| **役割** | 検査レポートを構造化JSONに変換 |
| **モデル** | Phi-4-mini-instruct-cuda-gpu:5 |
| **エンドポイント** | `http://127.0.0.1:52403/v1/chat/completions` |
| **API形式** | OpenAI互換 |

#### システムプロンプト（LOCAL_LAB_SYSTEM_PROMPT）

```
出力形式（JSON必須）:
{
  "overall_assessment": "短い平易な日本語での要約",
  "notable_abnormal_results": [
    {
      "test": "検査項目名",
      "value": "検査値",
      "unit": "単位（またはnull）",
      "reference_range": "基準範囲（またはnull）",
      "severity": "mild|moderate|severe"
    }
  ]
}

制約:
- JSON以外のテキスト禁止
- マークダウン・バッククォート禁止
- 不明フィールドはnull
- 値の捏造禁止
```

#### ツール関数仕様

```python
@ai_function(
    name="summarize_lab_report",
    description="ユーザーのGPU上で動作するローカルモデルを使用して、
                 生の検査レポートを構造化された異常値に要約します。"
)
def summarize_lab_report(
    lab_text: Annotated[str, Field(description="要約する検査レポートの生テキスト。")]
) -> Dict[str, Any]
```

---

## 3. データフロー

### 3.1 処理シーケンス

```
1. ユーザー入力受付
   │
   ├─ 患者症例テキスト
   └─ 検査レポートテキスト（オプション）

2. Azure ChatAgent処理
   │
   ├─ レッドフラグ症状チェック
   │   └─ 検出時 → 緊急医療勧告 → 終了
   │
   └─ 検査データ検出
       └─ summarize_lab_report()呼び出し

3. Foundry Local処理（ローカル）
   │
   ├─ HTTPリクエスト送信
   ├─ Phi-4-miniによるJSON生成
   ├─ コードフェンス除去
   └─ JSONパース・検証

4. 最終ガイダンス生成
   │
   ├─ 検査要約の平易な言葉での説明
   ├─ 次のステップ提案
   └─ 免責事項追加
```

### 3.2 入出力データ形式

#### 入力（ユーザーメッセージ）

```
患者症例:
10代の患者がひどい頭痛と嘔吐を訴えています。体温40度で、他の症状はありません。

以下は生テキストの検査結果です。必要に応じて、まず要約してください:
[検査レポートテキスト]

非緊急診断のガイダンスを提供してください。
```

#### ツール出力（JSON）

```json
{
  "overall_assessment": "炎症マーカーの上昇と軽度の白血球増多が認められ、急性感染症を示唆",
  "notable_abnormal_results": [
    {
      "test": "白血球数 (WBC)",
      "value": "14.5",
      "unit": "x10^3/µL",
      "reference_range": "4.0 – 10.0",
      "severity": "moderate"
    },
    {
      "test": "C反応性蛋白 (CRP)",
      "value": "60",
      "unit": "mg/L",
      "reference_range": "< 5 mg/L",
      "severity": "severe"
    }
  ]
}
```

---

## 4. 技術仕様

### 4.1 設定パラメータ

| パラメータ | 値 | 説明 |
|-----------|-----|------|
| `FOUNDRY_LOCAL_BASE` | `http://127.0.0.1:56234` | Foundry Localエンドポイント |
| `FOUNDRY_LOCAL_MODEL_ID` | `phi-4-mini-instruct-vitis-npu:2` | 使用モデル |
| `max_tokens` | 1024 | ローカルモデル最大トークン |
| `temperature` | 0.2 | ローカルモデル温度 |
| `timeout` | 120秒 | HTTPリクエストタイムアウト |

### 4.2 エラーハンドリング

| エラー種別 | 対応 |
|-----------|------|
| HTTP通信エラー | `resp.raise_for_status()`で例外発生 |
| JSONパースエラー | `json.loads()`で例外発生 |
| コードフェンス混入 | `strip_code_fences()`で自動除去 |

---

## 5. セキュリティ考慮事項

### 5.1 プライバシー保護

- **検査データのローカル処理**: 機密性の高い医療検査データはFoundry Localで処理され、クラウドに送信されない
- **構造化データのみ送信**: クラウドエージェントには要約済みの構造化JSONのみが渡される

### 5.2 免責事項

- すべての出力に「これは医学的アドバイスではありません。」を付与
- 診断・治療の処方は行わない設計

---

## 6. 実行方法

### 6.1 前提条件

1. **Foundry Localのインストール・起動**
   ```powershell
   winget install Microsoft.FoundryLocal
   foundry model download phi-4-mini
   foundry model load phi-4-mini
   foundry service status  # ポート確認
   ```

2. **Azure CLIログイン**
   ```powershell
   az login
   ```

3. **依存パッケージのインストール**
   ```powershell
   pip install -r requirements.txt
   ```

### 6.2 実行

```powershell
# プロジェクトルートから実行
python -m medical.agent
```

---

## 7. ファイル構成

```
medical/
├── __init__.py          # パッケージ初期化
├── agent.py             # メインエージェント
├── DESIGN.md            # 本設計書
└── README.md            # ユースケース説明
```

---

## 8. 改訂履歴

| 日付 | バージョン | 内容 |
|------|-----------|------|
| 2025/11/30 | 1.0 | 初版作成（日本語化完了版） |
| 2025/11/30 | 2.0 | medical/フォルダへの分離 |
